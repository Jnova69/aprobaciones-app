<div class="container">
  <!-- Loading -->
  <div class="spinner-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Contenido -->
  <div *ngIf="!loading && solicitud">
    
    <!-- Header con código y estado -->
    <div class="header">
      <div class="header-left">
        <button mat-icon-button (click)="volver()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <h1>{{ solicitud.titulo }}</h1>
          <span class="codigo">{{ solicitud.codigoSolicitud }}</span>
        </div>
      </div>
      <mat-chip [class]="'estado-chip ' + getEstadoClass(solicitud.estado)">
        <mat-icon>
          {{ solicitud.estado === EstadoSolicitud.PENDIENTE ? 'schedule' : 
             solicitud.estado === EstadoSolicitud.APROBADO ? 'check_circle' : 'cancel' }}
        </mat-icon>
        {{ solicitud.estado }}
      </mat-chip>
    </div>

    <!-- Grid principal -->
    <div class="content-grid">
      
      <!-- Columna Izquierda: Detalles -->
      <div class="left-column">
        
        <!-- Información General -->
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              <mat-icon>info</mat-icon>
              Información General
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="info-grid">
              <div class="info-item">
                <label>Tipo de Solicitud:</label>
                <span class="value">{{ solicitud.tipoSolicitud?.nombre }}</span>
              </div>
              <div class="info-item">
                <label>Solicitante:</label>
                <span class="value">
                  <mat-icon>person</mat-icon>
                  {{ solicitud.solicitante?.nombreCompleto }}
                  <small>({{ solicitud.solicitante?.usuarioRed }})</small>
                </span>
              </div>
              <div class="info-item">
                <label>Responsable:</label>
                <span class="value">
                  <mat-icon>supervisor_account</mat-icon>
                  {{ solicitud.responsable?.nombreCompleto }}
                  <small>({{ solicitud.responsable?.usuarioRed }})</small>
                </span>
              </div>
              <div class="info-item">
                <label>Fecha de Solicitud:</label>
                <span class="value">{{ solicitud.fechaSolicitud | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="info-item" *ngIf="solicitud.fechaRespuesta">
                <label>Fecha de Respuesta:</label>
                <span class="value">{{ solicitud.fechaRespuesta | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Descripción -->
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              <mat-icon>description</mat-icon>
              Descripción
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p class="descripcion">{{ solicitud.descripcion }}</p>
          </mat-card-content>
        </mat-card>

        <!-- Comentarios -->
        <mat-card *ngIf="solicitud.comentarios && solicitud.comentarios.length > 0">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>comment</mat-icon>
              Comentarios
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-list>
              <mat-list-item *ngFor="let comentario of solicitud.comentarios">
                <div class="comentario-item">
                  <div class="comentario-header">
                    <strong>{{ comentario.usuario?.nombreCompleto }}</strong>
                    <span class="fecha">{{ comentario.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <p>{{ comentario.comentario }}</p>
                </div>
              </mat-list-item>
            </mat-list>
          </mat-card-content>
        </mat-card>

      </div>

      <!-- Columna Derecha: Acciones e Historial -->
      <div class="right-column">
        
        <!-- Acciones (solo si está pendiente y es el responsable) -->
        <mat-card class="acciones-card" *ngIf="puedeAprobarRechazar()">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>task_alt</mat-icon>
              Acciones
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            
            <!-- Aprobar -->
            <mat-expansion-panel class="aprobar-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>check_circle</mat-icon>
                  Aprobar Solicitud
                </mat-panel-title>
              </mat-expansion-panel-header>
              <form [formGroup]="aprobarForm">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Comentario (Opcional)</mat-label>
                  <textarea 
                    matInput 
                    formControlName="comentario"
                    placeholder="Agrega un comentario..."
                    rows="3">
                  </textarea>
                </mat-form-field>
                <button 
                  mat-raised-button 
                  color="primary"
                  (click)="aprobar()"
                  [disabled]="procesando"
                  class="full-width">
                  <mat-spinner diameter="20" *ngIf="procesando"></mat-spinner>
                  <mat-icon *ngIf="!procesando">check</mat-icon>
                  {{ procesando ? 'Procesando...' : 'Aprobar' }}
                </button>
              </form>
            </mat-expansion-panel>

            <!-- Rechazar -->
            <mat-expansion-panel class="rechazar-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>cancel</mat-icon>
                  Rechazar Solicitud
                </mat-panel-title>
              </mat-expansion-panel-header>
              <form [formGroup]="rechazarForm">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Motivo de Rechazo *</mat-label>
                  <textarea 
                    matInput 
                    formControlName="comentario"
                    placeholder="Describe el motivo del rechazo..."
                    rows="3"
                    required>
                  </textarea>
                  <mat-error *ngIf="rechazarForm.get('comentario')?.hasError('required')">
                    El motivo es obligatorio
                  </mat-error>
                </mat-form-field>
                <button 
                  mat-raised-button 
                  color="warn"
                  (click)="rechazar()"
                  [disabled]="procesando"
                  class="full-width">
                  <mat-spinner diameter="20" *ngIf="procesando"></mat-spinner>
                  <mat-icon *ngIf="!procesando">close</mat-icon>
                  {{ procesando ? 'Procesando...' : 'Rechazar' }}
                </button>
              </form>
            </mat-expansion-panel>

          </mat-card-content>
        </mat-card>

        <!-- Mensaje si ya fue procesada -->
        <mat-card *ngIf="!puedeAprobarRechazar() && solicitud.estado !== EstadoSolicitud.PENDIENTE">
          <mat-card-content>
            <div class="info-message">
              <mat-icon>info</mat-icon>
              <p>Esta solicitud ya ha sido {{ solicitud.estado === EstadoSolicitud.APROBADO ? 'aprobada' : 'rechazada' }}</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Historial -->
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              <mat-icon>history</mat-icon>
              Historial de Cambios
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-list *ngIf="historial.length > 0">
              <mat-list-item *ngFor="let item of historial; let last = last">
                <div class="historial-item">
                  <div class="historial-header">
                    <mat-chip class="accion-chip">{{ item.accion }}</mat-chip>
                    <span class="fecha">{{ item.fechaAccion | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="historial-content">
                    <strong>{{ item.usuario?.nombreCompleto }}</strong>
                    <div *ngIf="item.estadoAnterior && item.estadoNuevo" class="estado-cambio">
                      <span class="estado-badge">{{ item.estadoAnterior }}</span>
                      <mat-icon>arrow_forward</mat-icon>
                      <span class="estado-badge">{{ item.estadoNuevo }}</span>
                    </div>
                    <p *ngIf="item.comentario" class="comentario-historial">
                      <mat-icon>chat_bubble_outline</mat-icon>
                      {{ item.comentario }}
                    </p>
                  </div>
                </div>
                <mat-divider *ngIf="!last"></mat-divider>
              </mat-list-item>
            </mat-list>
            <div *ngIf="historial.length === 0" class="no-historial">
              <mat-icon>inbox</mat-icon>
              <p>No hay historial disponible</p>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

    </div>

  </div>
</div>